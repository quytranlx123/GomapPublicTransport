<div th:fragment="map">
    <div id="map" style="width: 100%; height: 500px; position: relative;">
        <!-- N√∫t n·ªïi tr√™n b·∫£n ƒë·ªì -->
        <button id="btnCurrentLocation"
                style="position: absolute;
                z-index: 999;
                bottom: 10px;
                left: 10px;
                padding: 8px 12px;
                background: white;
                border: 1px solid #ccc;
                border-radius: 4px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                cursor: pointer;">
            V·ªã tr√≠ hi·ªán t·∫°i
        </button>
        <div id="coordinateBox" style="
             position: absolute;
             bottom: 10px;
             right: 10px;
             z-index: 2;
             background: white;
             padding: 8px 10px;
             border: 1px solid #ccc;
             border-radius: 6px;
             font-size: 14px;
             display: none;
             max-width: 280px;
             ">
            <div>
                <span id="coordinateText">Lat: --, Lng: --</span> 
                <button id="copyCoords" style="margin-left: 8px; padding: 2px 6px;">üìã</button>
            </div>
            <div style="margin-top: 6px;">
                <span id="addressText">ƒê·ªãa ch·ªâ: --</span> 
                <button id="copyAddress" style="margin-left: 8px; padding: 2px 6px;">üìã</button>
            </div>
            <span id="countdown" style="margin-left: 0; color: gray; display: block; margin-top: 6px;">(10s)</span>
        </div>

    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const stations = /*[[${stations}]]*/ [];
        const vehicles = /*[[${vehicles}]]*/ [];
        /*]]>*/

        mapboxgl.accessToken = 'pk.eyJ1IjoicXV5dHJhbmx4MTIzIiwiYSI6ImNtYTdxYnNsZTBpaXIyam9iNTRzNDN3YWIifQ.zWSkoAn4LPl8DzJL4fLmCw';

        const stationsGeoJSON = {
            type: 'FeatureCollection',
            features: stations.map(station => ({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [parseFloat(station.longitude), parseFloat(station.latitude)]
                    },
                    properties: {
                        description: station.name,
                        address: station.address  // th√™m address
                    }
                }))
        };

        const vehiclesGeoJSON = {
            type: 'FeatureCollection',
            features: vehicles.map(vehicle => ({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [parseFloat(vehicle.longitude), parseFloat(vehicle.latitude)]
                    },
                    properties: {
                        description: vehicle.licensePlate,
                        driver: vehicle.driver  // th√™m driver
                    }
                }))
        };
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [106.660172, 10.762622],
            zoom: 12
        }
        );

        // Th√™m √¥ t√¨m ki·∫øm
        const geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl,
            placeholder: 'Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒëi ho·∫∑c ƒëi·ªÉm ƒë·∫øn',
            marker: false
        });
        map.addControl(geocoder);

        let searchMarker = null;
        geocoder.on('result', function (e) {
            const coordinates = e.result.geometry.coordinates;
            const placeName = e.result.place_name;

            if (searchMarker)
                searchMarker.remove();

            searchMarker = new mapboxgl.Marker({color: 'red'})
                    .setLngLat(coordinates)
                    .setPopup(new mapboxgl.Popup().setText(placeName))
                    .addTo(map);

            searchMarker.getElement().addEventListener('click', () => {
                // L·∫•y t·ªça ƒë·ªô marker
                const lngLat = marker.getLngLat();
                showCoordinates(lngLat.lat, lngLat.lng);
            });


            map.flyTo({center: coordinates, zoom: 14});
            showCoordinates(coordinates[1], coordinates[0]);
        });

        // T·∫£i icon v√† d·ªØ li·ªáu
        map.on('load', () => {
            map.doubleClickZoom.disable();
            map.loadImage('/gomap/images/bus-station.png', (error, image) => {
                if (error)
                    throw error;
                map.addImage('bus-station-icon', image);
                map.addSource('stations', {
                    type: 'geojson',
                    data: stationsGeoJSON,
                    cluster: true,
                    clusterMaxZoom: 14,
                    clusterRadius: 50
                });

                map.addLayer({
                    id: 'clusters',
                    type: 'symbol',
                    source: 'stations',
                    filter: ['has', 'point_count'],
                    layout: {
                        'icon-image': 'bus-station-icon',
                        'icon-size': 1,
                        'text-field': '{point_count_abbreviated}',
                        'text-size': 14,
                        'text-offset': [0, 0.5],
                        'text-anchor': 'top'
                    },
                    paint: {'text-color': '#fff'}
                });

                map.addLayer({
                    id: 'stations-layer',
                    type: 'symbol',
                    source: 'stations',
                    filter: ['!', ['has', 'point_count']],
                    layout: {
                        'icon-image': 'bus-station-icon',
                        'icon-size': 1,
                        'icon-allow-overlap': true
                    }
                });
            });

            map.loadImage('/gomap/images/bus.png', (error, image) => {
                if (error)
                    throw error;
                map.addImage('bus-icon', image);
                map.addSource('vehicles', {
                    type: 'geojson',
                    data: vehiclesGeoJSON
                });

                map.addLayer({
                    id: 'vehicles-layer',
                    type: 'symbol',
                    source: 'vehicles',
                    layout: {
                        'icon-image': 'bus-icon',
                        'icon-size': 1,
                        'icon-allow-overlap': true
                    }
                });
            });
        });

        // L·∫•y v·ªã tr√≠ hi·ªán t·∫°i
        let currentLocationMarker = null; // Bi·∫øn l∆∞u marker hi·ªán t·∫°i

        document.getElementById('btnCurrentLocation').addEventListener('click', () => {
            if (!navigator.geolocation) {
                console.warn('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.');
                return;
            }

            navigator.geolocation.getCurrentPosition(position => {
                const {latitude, longitude} = position.coords;

                // X√≥a marker c≈© n·∫øu c√≥
                if (currentLocationMarker) {
                    currentLocationMarker.remove();
                }

                // T·∫°o marker m·ªõi
                currentLocationMarker = new mapboxgl.Marker({color: 'blue'})
                        .setLngLat([longitude, latitude])
                        .setPopup(new mapboxgl.Popup().setText('V·ªã tr√≠ hi·ªán t·∫°i c·ªßa b·∫°n'))
                        .addTo(map)
                        .togglePopup();

                // G·∫Øn s·ª± ki·ªán click ƒë·ªÉ hi·ªÉn th·ªã t·ªça ƒë·ªô
                currentLocationMarker.getElement().addEventListener('click', () => {
                    showCoordinates(latitude, longitude);
                });

                // Di chuy·ªÉn map ƒë·∫øn v·ªã tr√≠
                map.easeTo({center: [longitude, latitude], zoom: 14, duration: 1000});

                showCoordinates(latitude, longitude);
            }, error => {
                console.warn('Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ hi·ªán t·∫°i: ' + error.message);
            });
        });



        // Di chuy·ªÉn ƒë·∫øn
        let destinationMarker = null;
        let btnNavigate = null;

        function removeRouteLayers() {
            ['route-to-station', 'route-to-vehicle'].forEach(id => {
                if (map.getLayer(id))
                    map.removeLayer(id);
                if (map.getSource(id))
                    map.removeSource(id);
            });
        }

        function haversine(coord1, coord2) {
            const R = 6371e3;
            const toRad = deg => deg * Math.PI / 180;
            const [lon1, lat1] = coord1;
            const [lon2, lat2] = coord2;
            const œÜ1 = toRad(lat1), œÜ2 = toRad(lat2);
            const ŒîœÜ = toRad(lat2 - lat1);
            const ŒîŒª = toRad(lon2 - lon1);
            const a = Math.sin(ŒîœÜ / 2) ** 2 + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function createNavigateButton(startCoords, description) {
            if (btnNavigate)
                btnNavigate.remove();

            btnNavigate = document.createElement('button');
            btnNavigate.textContent = 'Di chuy·ªÉn ƒë·∫øn';
            Object.assign(btnNavigate.style, {
                position: 'absolute',
                zIndex: 2,
                top: '60px',
                left: '10px',
                background: '#f0c14b',
                border: '1px solid #a88734',
                padding: '6px 12px',
                cursor: 'pointer'
            });
            document.getElementById('map').appendChild(btnNavigate);

            btnNavigate.onclick = () => {
                removeRouteLayers();

                let nearestStation = null, minDistStation = Infinity;
                for (const f of stationsGeoJSON.features) {
                    const dist = haversine(startCoords, f.geometry.coordinates);
                    if (dist < minDistStation) {
                        minDistStation = dist;
                        nearestStation = f.geometry.coordinates;
                    }
                }

                let nearestVehicle = null, minDistVehicle = Infinity;
                for (const f of vehiclesGeoJSON.features) {
                    const dist = haversine(nearestStation, f.geometry.coordinates);
                    if (dist < minDistVehicle) {
                        minDistVehicle = dist;
                        nearestVehicle = f.geometry.coordinates;
                    }
                }

                map.addSource('route-to-station', {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        geometry: {
                            type: 'LineString',
                            coordinates: [startCoords, nearestStation]
                        }
                    }
                });

                map.addLayer({
                    id: 'route-to-station',
                    type: 'line',
                    source: 'route-to-station',
                    paint: {
                        'line-color': '#f1c40f',
                        'line-width': 4
                    }
                });

                map.addSource('route-to-vehicle', {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        geometry: {
                            type: 'LineString',
                            coordinates: [nearestStation, nearestVehicle]
                        }
                    }
                });

                map.addLayer({
                    id: 'route-to-vehicle',
                    type: 'line',
                    source: 'route-to-vehicle',
                    paint: {
                        'line-color': '#3498db',
                        'line-width': 4
                    }
                });
            };
        }

        map.on('click', (e) => {
            const feature = e.features?.[0];
            if (!feature)
                return;

            const coords = feature.geometry.coordinates;
            const desc = feature.properties.description;

            createNavigateButton(coords, desc);
            showCoordinates(coords[1], coords[0]);
        });

        // Hi·ªÉn th·ªã v√† sao ch√©p t·ªça ƒë·ªô
        const coordinateBox = document.getElementById('coordinateBox');
        const coordinateText = document.getElementById('coordinateText');
        const countdown = document.getElementById('countdown');
        const copyCoords = document.getElementById('copyCoords');
        const addressText = document.getElementById('addressText');
        const copyAddress = document.getElementById('copyAddress');

        async function showCoordinates(lat, lng) {
            const coordFormatted = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
            coordinateText.textContent = coordFormatted;
            addressText.textContent = 'ƒêang l·∫•y ƒë·ªãa ch·ªâ...';

            coordinateBox.style.display = 'block';

            // L·∫•y ƒë·ªãa ch·ªâ async
            const address = await fetchAddress(lat, lng);
            addressText.textContent = `ƒê·ªãa ch·ªâ: ${address}`;

            let timeLeft = 10;
            countdown.textContent = `(${timeLeft}s)`;

            if (showCoordinates.countdownInterval) {
                clearInterval(showCoordinates.countdownInterval);
            }

            showCoordinates.countdownInterval = setInterval(() => {
                timeLeft--;
                countdown.textContent = `(${timeLeft}s)`;
                if (timeLeft <= 0) {
                    clearInterval(showCoordinates.countdownInterval);
                    coordinateBox.style.display = 'none';
                }
            }, 1000);

            // N√∫t copy t·ªça ƒë·ªô
            copyCoords.onclick = () => {
                navigator.clipboard.writeText(`${lat.toFixed(6)}, ${lng.toFixed(6)}`).then(() => {
                    copyCoords.textContent = '‚úÖ';
                    setTimeout(() => {
                        copyCoords.textContent = 'üìã';
                    }, 1000);
                });
            };

            // N√∫t copy ƒë·ªãa ch·ªâ
            copyAddress.onclick = () => {
                navigator.clipboard.writeText(address).then(() => {
                    copyAddress.textContent = '‚úÖ';
                    setTimeout(() => {
                        copyAddress.textContent = 'üìã';
                    }, 1000);
                });
            };

            clearTimeout(showCoordinates.hideTimeout);
            showCoordinates.hideTimeout = setTimeout(() => {
                coordinateBox.style.display = 'none';
                clearInterval(showCoordinates.countdownInterval);
            }, 10000);
        }



        // S·ª± ki·ªán click cho tr·∫°m xe bu√Ωt
        map.on('click', 'stations-layer', function (e) {
            const coordinates = e.features[0].geometry.coordinates.slice();
            const description = e.features[0].properties.description;
            const address = e.features[0].properties.address;

            new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(`<strong>${description}</strong><br/>${address}`)
                    .addTo(map);

            createNavigateButton(coordinates, description);
            showCoordinates(coordinates[1], coordinates[0]);
        });



// S·ª± ki·ªán click cho xe bu√Ωt
        map.on('click', 'vehicles-layer', function (e) {
            const coordinates = e.features[0].geometry.coordinates.slice();
            const description = e.features[0].properties.description;
            const driver = e.features[0].properties.driver;

            new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(`<strong>${description}</strong><br/>T√†i x·∫ø: ${driver}`)
                    .addTo(map);

            createNavigateButton(coordinates, description);
            showCoordinates(coordinates[1], coordinates[0]);
        });


        map.on('mouseenter', 'stations-layer', () => {
            map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'stations-layer', () => {
            map.getCanvas().style.cursor = '';
        });

        map.on('mouseenter', 'vehicles-layer', () => {
            map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'vehicles-layer', () => {
            map.getCanvas().style.cursor = '';
        });
        map.on('click', 'clusters', function (e) {
            const features = map.queryRenderedFeatures(e.point, {
                layers: ['clusters']
            });
            const clusterId = features[0].properties.cluster_id;
            map.getSource('stations').getClusterExpansionZoom(clusterId, function (err, zoom) {
                if (err)
                    return;

                map.easeTo({
                    center: features[0].geometry.coordinates,
                    zoom: zoom
                });
            });
        });

//        double click
        let doubleClickMarker = null;
        let lastLatLng = null;

        map.on('dblclick', function (e) {
            const {lng, lat} = e.lngLat;

            // Xo√° marker c≈© n·∫øu c√≥
            if (doubleClickMarker) {
                doubleClickMarker.remove();
            }

            // T·∫°o marker m·ªõi ·ªü v·ªã tr√≠ click
            doubleClickMarker = new mapboxgl.Marker({color: 'green'})
                    .setLngLat([lng, lat])
                    .addTo(map);

            // L∆∞u l·∫°i v·ªã tr√≠ ƒë·ªÉ s·ª≠ d·ª•ng l·∫°i khi click marker
            lastLatLng = {lat, lng};

            // Hi·ªÉn th·ªã t·ªça ƒë·ªô ngay khi double click
            showCoordinates(lat, lng);

            // L·∫•y ƒë·ªãa ch·ªâ t·ª´ t·ªça ƒë·ªô v√† t·∫°o popup
            getAddressFromCoordinates(lat, lng)
                    .then(address => {
                        doubleClickMarker.setPopup(new mapboxgl.Popup().setText(address)).togglePopup();
                    })
                    .catch(() => {
                        doubleClickMarker.setPopup(new mapboxgl.Popup().setText('Kh√¥ng th·ªÉ l·∫•y ƒë·ªãa ch·ªâ')).togglePopup();
                    });

            // Th√™m s·ª± ki·ªán click v√†o marker
            doubleClickMarker.getElement().addEventListener('click', () => {
                if (!lastLatLng)
                    return;

                // Hi·ªÉn th·ªã l·∫°i t·ªça ƒë·ªô
                showCoordinates(lastLatLng.lat, lastLatLng.lng);

                // L·∫•y l·∫°i ƒë·ªãa ch·ªâ r·ªìi hi·ªÉn th·ªã popup
                getAddressFromCoordinates(lastLatLng.lat, lastLatLng.lng)
                        .then(address => {
                            doubleClickMarker.setPopup(new mapboxgl.Popup().setText(address)).togglePopup();

                        })
                        .catch(() => {
                            doubleClickMarker.setPopup(new mapboxgl.Popup().setText('Kh√¥ng th·ªÉ l·∫•y ƒë·ªãa ch·ªâ')).togglePopup();
                        });
            });
        });


        async function fetchAddress(lat, lng) {
            const accessToken = 'pk.eyJ1IjoicXV5dHJhbmx4MTIzIiwiYSI6ImNtYTdxYnNsZTBpaXIyam9iNTRzNDN3YWIifQ.zWSkoAn4LPl8DzJL4fLmCw';
            const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${accessToken}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.features && data.features.length > 0) {
                    return data.features[0].place_name;
                }
            } catch (e) {
                console.error('L·ªói l·∫•y ƒë·ªãa ch·ªâ:', e);
            }
            return 'Kh√¥ng x√°c ƒë·ªãnh';
        }

    </script>
</div>
